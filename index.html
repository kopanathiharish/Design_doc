<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advaita Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="index.css">
</head>
<body class="flex h-screen font-sans" x-data="dashboardData()">

  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r shadow-md p-4">
    <h1 class="text-xl font-bold mb-6 text-blue-600">Advaita Admin</h1>
    <nav class="space-y-4">
      <a href="#" @click="activeTab = 'users'" :class="activeTab === 'users' ? 'text-blue-600 font-semibold' : 'text-gray-600 hover:text-blue-500'" class="flex items-center">
        <i class="fas fa-users mr-2"></i>Users
      </a>
      <a href="#" @click="activeTab = 'subscriptions'" :class="activeTab === 'subscriptions' ? 'text-blue-600 font-semibold' : 'text-gray-600 hover:text-blue-500'" class="flex items-center">
        <i class="fas fa-credit-card mr-2"></i>Subscriptions
      </a>
      <a href="#" @click="activeTab = 'expiring'" :class="activeTab === 'expiring' ? 'text-blue-600 font-semibold' : 'text-gray-600 hover:text-blue-500'" class="flex items-center">
        <i class="fas fa-clock mr-2"></i>Expiring Soon
      </a>
      <a href="#" @click="activeTab = 'analytics'" :class="activeTab === 'analytics' ? 'text-blue-600 font-semibold' : 'text-gray-600 hover:text-blue-500'" class="flex items-center">
        <i class="fas fa-chart-bar mr-2"></i>Analytics
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 overflow-y-auto">
    
    <!-- Users Tab -->
    <div x-show="activeTab === 'users'">
      <header class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold">User Management</h2>
        <div class="flex space-x-2">
          <button @click="showCreateUserModal = true" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            <i class="fas fa-plus mr-2"></i>Add User
          </button>
          <button class="border border-gray-300 text-gray-600 px-4 py-2 rounded hover:bg-gray-100">
            <i class="fas fa-download mr-2"></i>Export
          </button>
        </div>
      </header>

      <!-- Search & Filters -->
      <div class="flex items-center mb-4 space-x-4">
        <input type="text" x-model="userSearch" placeholder="Search by name, institution, or email..."
          class="w-full border px-4 py-2 rounded shadow-sm"/>
        <select x-model="userSortBy" class="border px-4 py-2 rounded shadow-sm">
          <option value="firstName">First Name</option>
          <option value="lastName">Last Name</option>
          <option value="institution">Institution</option>
          <option value="email">Email</option>
          <option value="expiryDate">Expiry Date</option>
          <option value="activationDate">Activation Date</option>
          <option value="createdDate">Created Date</option>
        </select>
        <button @click="userSortOrder = userSortOrder === 'asc' ? 'desc' : 'asc'" class="bg-gray-100 text-gray-600 px-4 py-2 rounded hover:bg-gray-200">
          <i class="fas fa-sort" :class="userSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
        </button>
      </div>

      <!-- User Table -->
      <div class="overflow-x-auto bg-white shadow-md rounded">
        <table class="min-w-full text-sm text-left">
                      <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-4 py-2">First Name</th>
                <th class="px-4 py-2">Last Name</th>
                <th class="px-4 py-2">Institution</th>
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Expiry</th>
                <th class="px-4 py-2">Activation</th>
                <th class="px-4 py-2">Created</th>
                <th class="px-4 py-2">Reports Used</th>
                <th class="px-4 py-2">Users Subscription</th>
                <th class="px-4 py-2">Actions</th>
              </tr>
            </thead>
          <tbody class="text-gray-600">
            <template x-for="user in filteredUsers" :key="user.id">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-2" x-text="user.firstName"></td>
                <td class="px-4 py-2" x-text="user.lastName"></td>
                <td class="px-4 py-2" x-text="user.institution"></td>
                <td class="px-4 py-2" x-text="user.email"></td>
                <td class="px-4 py-2">
                  <span :class="user.status === 'Active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'" 
                        class="px-2 py-1 rounded text-xs" x-text="user.status"></span>
                </td>
                <td class="px-4 py-2" x-text="user.expiryDate"></td>
                <td class="px-4 py-2" x-text="user.activationDate"></td>
                <td class="px-4 py-2" x-text="user.createdDate"></td>
                <td class="px-4 py-2" x-text="user.reportsUsed + '/' + user.reportsTotal"></td>
                <td class="px-4 py-2">
                  <span class="text-sm font-medium text-blue-600" x-text="Math.floor(Math.random() * 3) + 1"></span>
                </td>
                <td class="px-4 py-2">
                  <button @click="editUser(user)" class="text-blue-500 hover:underline mr-2">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button @click="viewUserHistory(user)" class="text-green-500 hover:underline">
                    <i class="fas fa-history"></i>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Subscriptions Tab -->
    <div x-show="activeTab === 'subscriptions'">
      <!-- Subscription List View -->
      <div x-show="!showSubscriptionDetails">
        <header class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-semibold">Subscription Management</h2>
          <div class="flex space-x-2">
            <button @click="showCreateSubscriptionModal = true" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              <i class="fas fa-plus mr-2"></i>Create Subscription
            </button>
            <button @click="showAddEmailModal = true" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
              <i class="fas fa-envelope mr-2"></i>Add Email
            </button>
          </div>
        </header>

        <!-- Search & Filters -->
        <div class="flex items-center mb-4 space-x-4">
          <input type="text" x-model="subscriptionSearch" placeholder="Search subscriptions..."
            class="w-full border px-4 py-2 rounded shadow-sm"/>
          <select x-model="subscriptionSortBy" class="border px-4 py-2 rounded shadow-sm">
            <option value="userFirstName">User First Name</option>
            <option value="userLastName">User Last Name</option>
            <option value="institution">Institution</option>
            <option value="email">Email</option>
            <option value="expiryDate">Expiry Date</option>
            <option value="activationDate">Activation Date</option>
            <option value="totalValue">Total Value</option>
          </select>
          <button @click="subscriptionSortOrder = subscriptionSortOrder === 'asc' ? 'desc' : 'asc'" class="bg-gray-100 text-gray-600 px-4 py-2 rounded hover:bg-gray-200">
            <i class="fas fa-sort" :class="subscriptionSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
          </button>
        </div>

        <!-- Subscription Table -->
        <div class="overflow-x-auto bg-white shadow-md rounded">
          <table class="min-w-full text-sm text-left">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-4 py-2">Identifier</th>
                <th class="px-4 py-2">Institution</th>
                <th class="px-4 py-2">Number of Users</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Expiry</th>
                <th class="px-4 py-2">Activation</th>
                <th class="px-4 py-2">Reports</th>
                <th class="px-4 py-2">Total Value</th>
                <th class="px-4 py-2">Actions</th>
              </tr>
            </thead>
            <tbody class="text-gray-600">
              <template x-for="subscription in filteredSubscriptions" :key="subscription.id">
                <tr class="border-t hover:bg-gray-50">
                  <td class="px-4 py-2" x-text="subscription.subscriptionID"></td>
                  <td class="px-4 py-2" x-text="subscription.institution"></td>
                  <td class="px-4 py-2" x-text="subscription.numberOfUsers"></td>
                  <td class="px-4 py-2">
                    <span :class="subscription.status === 'Active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'" 
                          class="px-2 py-1 rounded text-xs" x-text="subscription.status"></span>
                  </td>
                  <td class="px-4 py-2" x-text="subscription.expiryDate"></td>
                  <td class="px-4 py-2" x-text="subscription.activationDate"></td>
                  <td class="px-4 py-2" x-text="subscription.reportsUsed + '/' + subscription.reportsTotal"></td>
                  <td class="px-4 py-2" x-text="'$' + subscription.totalValue"></td>
                  <td class="px-4 py-2">
                    <button @click="editSubscription(subscription)" class="text-blue-500 hover:underline mr-2">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button @click="extendSubscription(subscription)" class="text-green-500 hover:underline mr-2">
                      <i class="fas fa-plus"></i>
                    </button>
                    <button @click="viewSubscriptionDetails(subscription)" class="text-purple-500 hover:underline mr-2">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button @click="transferReports(subscription)" class="text-purple-500 hover:underline">
                      <i class="fas fa-exchange-alt"></i>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Subscription Details Page -->
      <div x-show="showSubscriptionDetails" class="space-y-6">
        <!-- Header with Back Button -->
        <header class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-4">
            <button @click="backToSubscriptionList()" class="text-blue-600 hover:text-blue-800">
              <i class="fas fa-arrow-left mr-2"></i>Back to Subscriptions
            </button>
            <h2 class="text-2xl font-semibold">Subscription Details</h2>
          </div>
          <div class="flex space-x-2">
            <button @click="showChangeAdminModal = true" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              <i class="fas fa-crown mr-2"></i>Change Admin
            </button>
            <button @click="showAddUserModal = true" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
              <i class="fas fa-plus mr-2"></i>Add User
            </button>
          </div>
        </header>

        <!-- Subscription Information Cards -->
        <div x-show="selectedSubscription" class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Subscription Info</h3>
            <div class="space-y-3">
              <div>
                <span class="text-sm text-gray-600">Subscription ID:</span>
                <p class="font-medium" x-text="selectedSubscription.subscriptionID"></p>
              </div>
              <div>
                <span class="text-sm text-gray-600">Institution:</span>
                <p class="font-medium" x-text="selectedSubscription.institution"></p>
              </div>
              <div>
                <span class="text-sm text-gray-600">Status:</span>
                <span :class="selectedSubscription.status === 'Active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'" 
                      class="px-2 py-1 rounded text-sm font-medium" x-text="selectedSubscription.status"></span>
              </div>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Usage Statistics</h3>
            <div class="space-y-3">
              <div>
                <span class="text-sm text-gray-600">Total Users:</span>
                <p class="font-medium text-xl" x-text="selectedSubscription.numberOfUsers"></p>
              </div>
              <div>
                <span class="text-sm text-gray-600">Reports Used:</span>
                <p class="font-medium" x-text="selectedSubscription.reportsUsed + '/' + selectedSubscription.reportsTotal"></p>
              </div>
              <div>
                <span class="text-sm text-gray-600">Total Value:</span>
                <p class="font-medium text-green-600" x-text="'$' + selectedSubscription.totalValue"></p>
              </div>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Admin</h3>
            <div class="space-y-3">
              <div>
                <span class="text-sm text-gray-600">Name:</span>
                <p class="font-medium" x-text="getAdminUser(selectedSubscription.adminUserId).firstName + ' ' + getAdminUser(selectedSubscription.adminUserId).lastName"></p>
              </div>
              <div>
                <span class="text-sm text-gray-600">Email:</span>
                <p class="font-medium" x-text="getAdminUser(selectedSubscription.adminUserId).email"></p>
              </div>
              <div>
                <span class="text-sm text-gray-600">Role:</span>
                <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-sm font-medium">Admin</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Users List -->
        <div class="bg-white rounded-lg shadow-md">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Subscription Users</h3>
            <p class="text-sm text-gray-600 mt-1">Manage users in this subscription</p>
          </div>
          
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Types</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="userId in selectedSubscription.users" :key="userId">
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                          <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <span class="text-sm font-medium text-blue-600" x-text="getSubscriptionUser(userId).firstName.charAt(0) + getSubscriptionUser(userId).lastName.charAt(0)"></span>
                          </div>
                        </div>
                        <div class="ml-4">
                          <div class="text-sm font-medium text-gray-900" x-text="getSubscriptionUser(userId).firstName + ' ' + getSubscriptionUser(userId).lastName"></div>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm text-gray-900" x-text="getSubscriptionUser(userId).firstName"></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm text-gray-900" x-text="getSubscriptionUser(userId).lastName"></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm text-gray-900" x-text="getSubscriptionUser(userId).email"></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span :class="getSubscriptionUser(userId).licenseStatus === 'Active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'" 
                            class="px-2 py-1 rounded text-xs font-medium" x-text="getSubscriptionUser(userId).licenseStatus || 'Active'"></span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <template x-for="type in getSubscriptionUserTypes(userId)" :key="type">
                        <span :class="type === 'IPG' ? 'bg-blue-100 text-blue-600' : type === 'IVG' ? 'bg-purple-100 text-purple-600' : 'bg-gray-100 text-gray-600'"
                              class="px-2 py-1 rounded text-xs font-medium mr-1" x-text="type"></span>
                      </template>
                      <span x-show="getSubscriptionUserTypes(userId).length === 0"
                            class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">Other</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm text-gray-900" x-text="getSubscriptionUser(userId).createdDate || 'N/A'"></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <div class="flex space-x-2">
                        <button @click="removeUserFromSubscription(selectedSubscription.id, userId)" 
                                class="text-red-600 hover:text-red-900" 
                                x-show="userId !== selectedSubscription.adminUserId">
                          <i class="fas fa-trash"></i>
                        </button>
                        <button @click="changeAdmin(selectedSubscription.id, userId)" 
                                class="text-blue-600 hover:text-blue-900" 
                                x-show="userId !== selectedSubscription.adminUserId">
                          <i class="fas fa-crown"></i>
                        </button>
                        <span x-show="userId === selectedSubscription.adminUserId" class="text-gray-400">
                          <i class="fas fa-shield-alt"></i>
                        </span>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Expiring Soon Tab -->
    <div x-show="activeTab === 'expiring'">
      <header class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold">Expiring Subscriptions</h2>
        <div class="flex space-x-2">
          <button @click="generateExpiringList(30)" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
            30 Days
          </button>
          <button @click="generateExpiringList(60)" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
            60 Days
          </button>
          <button @click="generateExpiringList(90)" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            90 Days
          </button>
        </div>
      </header>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-orange-600">Expiring in 30 days</h3>
          <p class="text-2xl font-bold" x-text="expiring30Days.length"></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-yellow-600">Expiring in 60 days</h3>
          <p class="text-2xl font-bold" x-text="expiring60Days.length"></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-red-600">Expiring in 90 days</h3>
          <p class="text-2xl font-bold" x-text="expiring90Days.length"></p>
        </div>
      </div>

      <div class="overflow-x-auto bg-white shadow-md rounded">
        <table class="min-w-full text-sm text-left">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-4 py-2">User Name</th>
              <th class="px-4 py-2">Email</th>
              <th class="px-4 py-2">Institution</th>
              <th class="px-4 py-2">Days Until Expiry</th>
              <th class="px-4 py-2">Reports Remaining</th>
              <th class="px-4 py-2">Actions</th>
            </tr>
          </thead>
          <tbody class="text-gray-600">
            <template x-for="subscription in expiringSubscriptions" :key="subscription.id">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-2" x-text="subscription.userFirstName + ' ' + subscription.userLastName"></td>
                <td class="px-4 py-2" x-text="subscription.numberOfUsers"></td>
                <td class="px-4 py-2" x-text="subscription.institution"></td>
                <td class="px-4 py-2">
                  <span :class="getDaysUntilExpiry(subscription.expiryDate) <= 30 ? 'text-red-600' : getDaysUntilExpiry(subscription.expiryDate) <= 60 ? 'text-yellow-600' : 'text-orange-600'" 
                        x-text="getDaysUntilExpiry(subscription.expiryDate) + ' days'"></span>
                </td>
                <td class="px-4 py-2" x-text="subscription.reportsTotal - subscription.reportsUsed"></td>
                <td class="px-4 py-2">
                  <button @click="extendSubscription(subscription)" class="text-blue-500 hover:underline">
                    <i class="fas fa-plus mr-1"></i>Extend
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div x-show="activeTab === 'analytics'">
      <header class="mb-6">
        <h2 class="text-2xl font-semibold">Usage Analytics</h2>
      </header>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-blue-600">Total Users</h3>
          <p class="text-2xl font-bold" x-text="users.length"></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-green-600">Active Subscriptions</h3>
          <p class="text-2xl font-bold" x-text="subscriptions.filter(s => s.status === 'Active').length"></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-purple-600">Total Reports Used</h3>
          <p class="text-2xl font-bold" x-text="totalReportsUsed"></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold text-orange-600">Revenue This Month</h3>
          <p class="text-2xl font-bold" x-text="'$' + monthlyRevenue"></p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-4">Most Active Users</h3>
          <div class="space-y-2">
            <template x-for="user in mostActiveUsers" :key="user.id">
              <div class="flex justify-between items-center">
                <span x-text="user.firstName + ' ' + user.lastName"></span>
                <span class="text-blue-600" x-text="user.reportsUsed + ' reports'"></span>
              </div>
            </template>
          </div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-4">Module Usage</h3>
          <div class="space-y-2">
            <template x-for="module in moduleUsage" :key="module.name">
              <div class="flex justify-between items-center">
                <span x-text="module.name"></span>
                <span class="text-green-600" x-text="module.usage + ' hours'"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Create User Modal -->
    <div x-show="showCreateUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-semibold mb-4">Create New User</h3>
        <form @submit.prevent="createUser()">
          <div class="space-y-4">
            <input type="text" x-model="newUser.firstName" placeholder="First Name" class="w-full border px-3 py-2 rounded">
            <input type="text" x-model="newUser.lastName" placeholder="Last Name" class="w-full border px-3 py-2 rounded">
            <input type="text" x-model="newUser.institution" placeholder="Institution" class="w-full border px-3 py-2 rounded">
            <input type="email" x-model="newUser.email" placeholder="Email" class="w-full border px-3 py-2 rounded">
            <input type="number" x-model="newUser.reportsTotal" placeholder="Number of Reports" class="w-full border px-3 py-2 rounded">
            <input type="date" x-model="newUser.expiryDate" class="w-full border px-3 py-2 rounded">
          </div>
          <div class="flex justify-end space-x-2 mt-4">
            <button type="button" @click="showCreateUserModal = false" class="px-4 py-2 border rounded">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Create</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Create Subscription Modal -->
    <div x-show="showCreateSubscriptionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-semibold mb-4">Create New Subscription</h3>
        <form @submit.prevent="createSubscription()">
          <div class="space-y-4">
            <select x-model="newSubscription.userId" class="w-full border px-3 py-2 rounded">
              <option value="">Select User</option>
              <template x-for="user in users" :key="user.id">
                <option :value="user.id" x-text="user.firstName + ' ' + user.lastName"></option>
              </template>
            </select>
            <input type="date" x-model="newSubscription.startDate" class="w-full border px-3 py-2 rounded">
            <input type="date" x-model="newSubscription.endDate" class="w-full border px-3 py-2 rounded">
            <input type="number" x-model="newSubscription.reportsTotal" placeholder="Number of Reports" class="w-full border px-3 py-2 rounded">
            <input type="text" x-model="newSubscription.application" placeholder="Application" class="w-full border px-3 py-2 rounded">
            <input type="number" x-model="newSubscription.totalValue" placeholder="Total Value" class="w-full border px-3 py-2 rounded">
          </div>
          <div class="flex justify-end space-x-2 mt-4">
            <button type="button" @click="showCreateSubscriptionModal = false" class="px-4 py-2 border rounded">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Create</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Email Modal -->
    <div x-show="showAddEmailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-semibold mb-4">Add Email to Subscription</h3>
        <form @submit.prevent="addEmailToSubscription()">
          <div class="space-y-4">
            <input type="email" x-model="newEmail.email" placeholder="Email Address" class="w-full border px-3 py-2 rounded">
            <select x-model="newEmail.subscriptionId" class="w-full border px-3 py-2 rounded">
              <option value="">Select Subscription</option>
              <template x-for="subscription in subscriptions" :key="subscription.id">
                <option :value="subscription.id" x-text="subscription.userFirstName + ' ' + subscription.userLastName"></option>
              </template>
            </select>
          </div>
          <div class="flex justify-end space-x-2 mt-4">
            <button type="button" @click="showAddEmailModal = false" class="px-4 py-2 border rounded">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Add Email</button>
          </div>
        </form>
      </div>
    </div>



    <!-- Change Admin Modal -->
    <div x-show="showChangeAdminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-lg font-semibold mb-4">Change Admin</h3>
        <div class="space-y-4">
          <p class="text-sm text-gray-600">Select new admin from subscription users:</p>
          <select x-model="newAdminUserId" class="w-full border px-3 py-2 rounded">
            <option value="">Select New Admin</option>
            <template x-for="userId in selectedSubscription.users" :key="userId">
              <option :value="userId" x-text="getSubscriptionUser(userId).firstName + ' ' + getSubscriptionUser(userId).lastName"></option>
            </template>
          </select>
        </div>
        <div class="flex justify-end space-x-2 mt-4">
          <button @click="showChangeAdminModal = false" class="px-4 py-2 border rounded">Cancel</button>
          <button @click="confirmChangeAdmin()" class="px-4 py-2 bg-blue-600 text-white rounded">Change Admin</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    function dashboardData() {
      return {
        activeTab: 'users',
        userSearch: '',
        userSortBy: 'firstName',
        userSortOrder: 'asc',
        subscriptionSearch: '',
        subscriptionSortBy: 'userFirstName',
        subscriptionSortOrder: 'asc',
        showCreateUserModal: false,
        showCreateSubscriptionModal: false,
        showAddEmailModal: false,
        selectedSubscription: null,
        showSubscriptionDetails: false,
        showChangeAdminModal: false,
        showAddUserModal: false,
        newAdminUserId: '',
        
        // Centralized synchronized data store
        dataStore: {
          users: [
            {
              id: 1,
              firstName: 'Alice',
              lastName: 'Smith',
              institution: 'University of California',
              email: 'alice.smith@uc.edu',
              status: 'Active',
              expiryDate: '2025-03-15',
              activationDate: '2024-03-15',
              createdDate: '2024-01-10',
              reportsUsed: 45,
              reportsTotal: 100,
              lastAccess: '2024-12-15',
              totalUsage: 156,
              moduleUsage: {
                'Data Analysis': 45,
                'Report Generation': 23,
                'Visualization': 67,
                'Export Tools': 21
              }
            },
            {
              id: 2,
              firstName: 'Bob',
              lastName: 'Johnson',
              institution: 'Stanford University',
              email: 'bob.johnson@stanford.edu',
              status: 'Active',
              expiryDate: '2025-06-20',
              activationDate: '2024-06-20',
              createdDate: '2024-02-15',
              reportsUsed: 78,
              reportsTotal: 150,
              lastAccess: '2024-12-14',
              totalUsage: 234,
              moduleUsage: {
                'Data Analysis': 78,
                'Report Generation': 45,
                'Visualization': 89,
                'Export Tools': 22
              }
            },
            {
              id: 3,
              firstName: 'Carol',
              lastName: 'Williams',
              institution: 'MIT',
              email: 'carol.williams@mit.edu',
              status: 'Inactive',
              expiryDate: '2024-12-01',
              activationDate: '2023-12-01',
              createdDate: '2023-10-20',
              reportsUsed: 120,
              reportsTotal: 120,
              lastAccess: '2024-11-30',
              totalUsage: 445,
              moduleUsage: {
                'Data Analysis': 120,
                'Report Generation': 67,
                'Visualization': 189,
                'Export Tools': 69
              }
            },
            {
              id: 4,
              firstName: 'David',
              lastName: 'Brown',
              institution: 'Harvard University',
              email: 'david.brown@harvard.edu',
              status: 'Active',
              expiryDate: '2025-01-30',
              activationDate: '2024-01-30',
              createdDate: '2023-12-15',
              reportsUsed: 12,
              reportsTotal: 50,
              lastAccess: '2024-12-10',
              totalUsage: 89,
              moduleUsage: {
                'Data Analysis': 12,
                'Report Generation': 8,
                'Visualization': 45,
                'Export Tools': 24
              }
            },
            {
              id: 5,
              firstName: 'Emma',
              lastName: 'Davis',
              institution: 'Yale University',
              email: 'emma.davis@yale.edu',
              status: 'Active',
              expiryDate: '2025-04-10',
              activationDate: '2024-04-10',
              createdDate: '2024-01-25',
              reportsUsed: 89,
              reportsTotal: 200,
              lastAccess: '2024-12-15',
              totalUsage: 312,
              moduleUsage: {
                'Data Analysis': 89,
                'Report Generation': 34,
                'Visualization': 123,
                'Export Tools': 66
              }
            }
          ],
          
          subscriptions: [
            {
              id: 1,
              userId: 1,
              userFirstName: 'Alice',
              userLastName: 'Smith',
              subscriptionID: '1001',
              numberOfUsers: 10,
              institution: 'University of California',
              email: 'alice.smith@uc.edu',
              status: 'Active',
              expiryDate: '2025-03-15',
              activationDate: '2024-03-15',
              reportsUsed: 45,
              reportsTotal: 100,
              totalValue: 2500,
              application: 'Research Suite Pro',
              lastRun: '2024-12-15',
              shares: 12,
              timeSpent: 156,
              adminUserId: 1,
              users: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
            },
            {
              id: 2,
              userId: 2,
              userFirstName: 'Bob',
              userLastName: 'Johnson',
              subscriptionID: '1002',
              numberOfUsers: 10,
              institution: 'Stanford University',
              email: 'bob.johnson@stanford.edu',
              status: 'Active',
              expiryDate: '2025-06-20',
              activationDate: '2024-06-20',
              reportsUsed: 78,
              reportsTotal: 150,
              totalValue: 3750,
              application: 'Enterprise Analytics',
              lastRun: '2024-12-14',
              shares: 8,
              timeSpent: 234,
              adminUserId: 2,
              users: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
            },
            {
              id: 3,
              userId: 3,
              userFirstName: 'Carol',
              userLastName: 'Williams',
              subscriptionID: '1003',
              numberOfUsers: 20,
              institution: 'MIT',
              email: 'carol.williams@mit.edu',
              status: 'Expired',
              expiryDate: '2024-12-01',
              activationDate: '2023-12-01',
              reportsUsed: 120,
              reportsTotal: 120,
              totalValue: 3000,
              application: 'Academic Research',
              lastRun: '2024-11-30',
              shares: 25,
              timeSpent: 445,
              adminUserId: 3,
              users: [21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40]
            },
            {
              id: 4,
              userId: 4,
              userFirstName: 'David',
              userLastName: 'Brown',
              subscriptionID: '1004',
              numberOfUsers: 15,
              institution: 'Harvard University',
              email: 'david.brown@harvard.edu',
              status: 'Active',
              expiryDate: '2025-01-30',
              activationDate: '2024-01-30',
              reportsUsed: 12,
              reportsTotal: 50,
              totalValue: 1250,
              application: 'Basic Research',
              lastRun: '2024-12-10',
              shares: 3,
              timeSpent: 89,
              adminUserId: 4,
              users: [41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55]
            },
            {
              id: 5,
              userId: 5,
              userFirstName: 'Emma',
              userLastName: 'Davis',
              subscriptionID: '10890',
              numberOfUsers: 15,
              institution: 'Yale University',
              email: 'emma.davis@yale.edu',
              status: 'Active',
              expiryDate: '2025-04-10',
              activationDate: '2024-04-10',
              reportsUsed: 89,
              reportsTotal: 200,
              totalValue: 5000,
              application: 'Premium Analytics',
              lastRun: '2024-12-15',
              shares: 15,
              timeSpent: 312,
              adminUserId: 5,
              users: [56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70]
            }
          ],
          
          // Additional users for subscriptions
          subscriptionUsers: [
            // Users for subscription 1001 (UC)
            { id: 1, username: 'alice.smith', firstName: 'Alice', lastName: 'Smith', email: 'alice.smith@uc.edu', reportsUsed: 45, reportsTotal: 100, lastAccess: '2024-12-15', licenseStatus: 'Active', type: 'IPG', types: ['IPG','IVG'], createdDate: '2024-01-10' },
            { id: 2, username: 'john.davis', firstName: 'John', lastName: 'Davis', email: 'john.davis@uc.edu', reportsUsed: 23, reportsTotal: 50, lastAccess: '2024-12-14', licenseStatus: 'Active', type: 'IVG', types: ['IPG','IVG'], createdDate: '2024-02-15' },
            { id: 3, username: 'sarah.wilson', firstName: 'Sarah', lastName: 'Wilson', email: 'sarah.wilson@uc.edu', reportsUsed: 67, reportsTotal: 100, lastAccess: '2024-12-13', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-01-20' },
            { id: 4, username: 'michael.brown', firstName: 'Michael', lastName: 'Brown', email: 'michael.brown@uc.edu', reportsUsed: 12, reportsTotal: 50, lastAccess: '2024-12-12', licenseStatus: 'Active', type: 'Other', createdDate: '2024-03-01' },
            { id: 5, username: 'emily.johnson', firstName: 'Emily', lastName: 'Johnson', email: 'emily.johnson@uc.edu', reportsUsed: 89, reportsTotal: 150, lastAccess: '2024-12-11', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-02-01' },
            { id: 6, username: 'david.miller', firstName: 'David', lastName: 'Miller', email: 'david.miller@uc.edu', reportsUsed: 34, reportsTotal: 75, lastAccess: '2024-12-10', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-01-15' },
            { id: 7, username: 'lisa.garcia', firstName: 'Lisa', lastName: 'Garcia', email: 'lisa.garcia@uc.edu', reportsUsed: 56, reportsTotal: 100, lastAccess: '2024-12-09', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-02-10' },
            { id: 8, username: 'robert.martinez', firstName: 'Robert', lastName: 'Martinez', email: 'robert.martinez@uc.edu', reportsUsed: 78, reportsTotal: 120, lastAccess: '2024-12-08', licenseStatus: 'Active', type: 'Other', createdDate: '2024-03-05' },
            { id: 9, username: 'jennifer.anderson', firstName: 'Jennifer', lastName: 'Anderson', email: 'jennifer.anderson@uc.edu', reportsUsed: 45, reportsTotal: 80, lastAccess: '2024-12-07', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-01-25' },
            { id: 10, username: 'christopher.taylor', firstName: 'Christopher', lastName: 'Taylor', email: 'christopher.taylor@uc.edu', reportsUsed: 23, reportsTotal: 60, lastAccess: '2024-12-06', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-02-20' },
            
            // Users for subscription 1002 (Stanford)
            { id: 11, firstName: 'Bob', lastName: 'Johnson', email: 'bob.johnson@stanford.edu', reportsUsed: 78, reportsTotal: 150, lastAccess: '2024-12-14', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-06-20' },
            { id: 12, firstName: 'Maria', lastName: 'Gonzalez', email: 'maria.gonzalez@stanford.edu', reportsUsed: 45, reportsTotal: 100, lastAccess: '2024-12-13', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-07-01' },
            { id: 13, firstName: 'James', lastName: 'Rodriguez', email: 'james.rodriguez@stanford.edu', reportsUsed: 67, reportsTotal: 120, lastAccess: '2024-12-12', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-06-25' },
            { id: 14, firstName: 'Patricia', lastName: 'White', email: 'patricia.white@stanford.edu', reportsUsed: 89, reportsTotal: 150, lastAccess: '2024-12-11', licenseStatus: 'Active', type: 'Other', createdDate: '2024-07-05' },
            { id: 15, firstName: 'Thomas', lastName: 'Lee', email: 'thomas.lee@stanford.edu', reportsUsed: 34, reportsTotal: 80, lastAccess: '2024-12-10', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-07-10' },
            { id: 16, firstName: 'Nancy', lastName: 'Clark', email: 'nancy.clark@stanford.edu', reportsUsed: 56, reportsTotal: 100, lastAccess: '2024-12-09', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-06-30' },
            { id: 17, firstName: 'Daniel', lastName: 'Lewis', email: 'daniel.lewis@stanford.edu', reportsUsed: 23, reportsTotal: 60, lastAccess: '2024-12-08', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-07-15' },
            { id: 18, firstName: 'Karen', lastName: 'Hall', email: 'karen.hall@stanford.edu', reportsUsed: 78, reportsTotal: 120, lastAccess: '2024-12-07', licenseStatus: 'Active', type: 'Other', createdDate: '2024-07-20' },
            { id: 19, firstName: 'Steven', lastName: 'Young', email: 'steven.young@stanford.edu', reportsUsed: 45, reportsTotal: 90, lastAccess: '2024-12-06', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-07-25' },
            { id: 20, firstName: 'Betty', lastName: 'King', email: 'betty.king@stanford.edu', reportsUsed: 67, reportsTotal: 110, lastAccess: '2024-12-05', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-07-30' },
            
            // Users for subscription 1003 (MIT)
            { id: 21, firstName: 'Carol', lastName: 'Williams', email: 'carol.williams@mit.edu', reportsUsed: 120, reportsTotal: 120, lastAccess: '2024-11-30', licenseStatus: 'Expired', type: 'IPG', createdDate: '2023-12-01' },
            { id: 22, firstName: 'Richard', lastName: 'Scott', email: 'richard.scott@mit.edu', reportsUsed: 89, reportsTotal: 100, lastAccess: '2024-11-29', licenseStatus: 'Expired', type: 'IVG', createdDate: '2023-12-05' },
            { id: 23, firstName: 'Helen', lastName: 'Green', email: 'helen.green@mit.edu', reportsUsed: 67, reportsTotal: 80, lastAccess: '2024-11-28', licenseStatus: 'Expired', type: 'IPG', createdDate: '2023-12-10' },
            { id: 24, firstName: 'Joseph', lastName: 'Baker', email: 'joseph.baker@mit.edu', reportsUsed: 45, reportsTotal: 60, lastAccess: '2024-11-27', licenseStatus: 'Expired', type: 'Other', createdDate: '2023-12-15' },
            { id: 25, firstName: 'Deborah', lastName: 'Adams', email: 'deborah.adams@mit.edu', reportsUsed: 78, reportsTotal: 100, lastAccess: '2024-11-26', licenseStatus: 'Expired', type: 'IVG', createdDate: '2023-12-20' },
            { id: 26, firstName: 'Edward', lastName: 'Nelson', email: 'edward.nelson@mit.edu', reportsUsed: 56, reportsTotal: 75, lastAccess: '2024-11-25', licenseStatus: 'Expired', type: 'IPG', createdDate: '2023-12-25' },
            { id: 27, firstName: 'Sandra', lastName: 'Carter', email: 'sandra.carter@mit.edu', reportsUsed: 34, reportsTotal: 50, lastAccess: '2024-11-24', licenseStatus: 'Expired', type: 'IVG', createdDate: '2023-12-30' },
            { id: 28, firstName: 'Brian', lastName: 'Mitchell', email: 'brian.mitchell@mit.edu', reportsUsed: 67, reportsTotal: 90, lastAccess: '2024-11-23', licenseStatus: 'Expired', type: 'Other', createdDate: '2024-01-05' },
            { id: 29, firstName: 'Donna', lastName: 'Roberts', email: 'donna.roberts@mit.edu', reportsUsed: 23, reportsTotal: 40, lastAccess: '2024-11-22', licenseStatus: 'Expired', type: 'IPG', createdDate: '2024-01-10' },
            { id: 30, firstName: 'Ronald', lastName: 'Turner', email: 'ronald.turner@mit.edu', reportsUsed: 89, reportsTotal: 120, lastAccess: '2024-11-21', licenseStatus: 'Expired', type: 'IVG', createdDate: '2024-01-15' },
                          { id: 31, firstName: 'Michelle', lastName: 'Phillips', email: 'michelle.phillips@mit.edu', reportsUsed: 45, reportsTotal: 70, lastAccess: '2024-11-20', licenseStatus: 'Expired', type: 'IPG', createdDate: '2024-01-20' },
              { id: 32, firstName: 'Anthony', lastName: 'Campbell', email: 'anthony.campbell@mit.edu', reportsUsed: 78, reportsTotal: 100, lastAccess: '2024-11-19', licenseStatus: 'Expired', type: 'IVG', createdDate: '2024-01-25' },
              { id: 33, firstName: 'Dorothy', lastName: 'Parker', email: 'dorothy.parker@mit.edu', reportsUsed: 56, reportsTotal: 80, lastAccess: '2024-11-18', licenseStatus: 'Expired', type: 'Other', createdDate: '2024-01-30' },
              { id: 34, firstName: 'Kevin', lastName: 'Evans', email: 'kevin.evans@mit.edu', reportsUsed: 34, reportsTotal: 60, lastAccess: '2024-11-17', licenseStatus: 'Expired', type: 'IPG', createdDate: '2024-02-05' },
              { id: 35, firstName: 'Laura', lastName: 'Edwards', email: 'laura.edwards@mit.edu', reportsUsed: 67, reportsTotal: 90, lastAccess: '2024-11-16', licenseStatus: 'Expired', type: 'IVG', createdDate: '2024-02-10' },
              { id: 36, firstName: 'Jason', lastName: 'Collins', email: 'jason.collins@mit.edu', reportsUsed: 23, reportsTotal: 50, lastAccess: '2024-11-15', licenseStatus: 'Expired', type: 'IPG', createdDate: '2024-02-15' },
              { id: 37, firstName: 'Donna', lastName: 'Stewart', email: 'donna.stewart@mit.edu', reportsUsed: 89, reportsTotal: 110, lastAccess: '2024-11-14', licenseStatus: 'Expired', type: 'Other', createdDate: '2024-02-20' },
              { id: 38, firstName: 'Matthew', lastName: 'Sanchez', email: 'matthew.sanchez@mit.edu', reportsUsed: 45, reportsTotal: 70, lastAccess: '2024-11-13', licenseStatus: 'Expired', type: 'IVG', createdDate: '2024-02-25' },
              { id: 39, firstName: 'Carol', lastName: 'Morris', email: 'carol.morris@mit.edu', reportsUsed: 78, reportsTotal: 100, lastAccess: '2024-11-12', licenseStatus: 'Expired', type: 'IPG', createdDate: '2024-03-01' },
              { id: 40, firstName: 'Gary', lastName: 'Rogers', email: 'gary.rogers@mit.edu', reportsUsed: 56, reportsTotal: 80, lastAccess: '2024-11-11', licenseStatus: 'Expired', type: 'Other', createdDate: '2024-03-05' },
            
            // Users for subscription 1004 (Harvard)
            { id: 41, firstName: 'David', lastName: 'Brown', email: 'david.brown@harvard.edu', reportsUsed: 12, reportsTotal: 50, lastAccess: '2024-12-10', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-01-30' },
            { id: 42, firstName: 'Ruth', lastName: 'Reed', email: 'ruth.reed@harvard.edu', reportsUsed: 34, reportsTotal: 60, lastAccess: '2024-12-09', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-02-05' },
            { id: 43, firstName: 'James', lastName: 'Cook', email: 'james.cook@harvard.edu', reportsUsed: 67, reportsTotal: 100, lastAccess: '2024-12-08', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-02-10' },
            { id: 44, firstName: 'Janet', lastName: 'Morgan', email: 'janet.morgan@harvard.edu', reportsUsed: 45, reportsTotal: 80, lastAccess: '2024-12-07', licenseStatus: 'Active', type: 'Other', createdDate: '2024-02-15' },
            { id: 45, firstName: 'Paul', lastName: 'Bell', email: 'paul.bell@harvard.edu', reportsUsed: 23, reportsTotal: 50, lastAccess: '2024-12-06', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-02-20' },
            { id: 46, firstName: 'Margaret', lastName: 'Murphy', email: 'margaret.murphy@harvard.edu', reportsUsed: 78, reportsTotal: 120, lastAccess: '2024-12-05', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-02-25' },
            { id: 47, firstName: 'Mark', lastName: 'Bailey', email: 'mark.bailey@harvard.edu', reportsUsed: 56, reportsTotal: 90, lastAccess: '2024-12-04', licenseStatus: 'Active', type: 'Other', createdDate: '2024-03-01' },
            { id: 48, firstName: 'Elizabeth', lastName: 'Rivera', email: 'elizabeth.rivera@harvard.edu', reportsUsed: 34, reportsTotal: 70, lastAccess: '2024-12-03', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-03-05' },
            { id: 49, firstName: 'Donald', lastName: 'Cooper', email: 'donald.cooper@harvard.edu', reportsUsed: 89, reportsTotal: 110, lastAccess: '2024-12-02', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-03-10' },
            { id: 50, firstName: 'Jennifer', lastName: 'Richardson', email: 'jennifer.richardson@harvard.edu', reportsUsed: 23, reportsTotal: 60, lastAccess: '2024-12-01', licenseStatus: 'Active', type: 'Other', createdDate: '2024-03-15' },
            { id: 51, firstName: 'George', lastName: 'Cox', email: 'george.cox@harvard.edu', reportsUsed: 67, reportsTotal: 100, lastAccess: '2024-11-30', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-03-20' },
            { id: 52, firstName: 'Linda', lastName: 'Howard', email: 'linda.howard@harvard.edu', reportsUsed: 45, reportsTotal: 80, lastAccess: '2024-11-29', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-03-25' },
            { id: 53, firstName: 'Kenneth', lastName: 'Ward', email: 'kenneth.ward@harvard.edu', reportsUsed: 78, reportsTotal: 120, lastAccess: '2024-11-28', licenseStatus: 'Active', type: 'Other', createdDate: '2024-03-30' },
            { id: 54, firstName: 'Patricia', lastName: 'Torres', email: 'patricia.torres@harvard.edu', reportsUsed: 56, reportsTotal: 90, lastAccess: '2024-11-27', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-04-05' },
            { id: 55, firstName: 'Steven', lastName: 'Peterson', email: 'steven.peterson@harvard.edu', reportsUsed: 34, reportsTotal: 70, lastAccess: '2024-11-26', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-04-10' },
            
            // Users for subscription 10890 (Yale)
            { id: 56, firstName: 'Emma', lastName: 'Davis', email: 'emma.davis@yale.edu', reportsUsed: 89, reportsTotal: 200, lastAccess: '2024-12-15', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-04-10' },
            { id: 57, firstName: 'Barbara', lastName: 'Gray', email: 'barbara.gray@yale.edu', reportsUsed: 67, reportsTotal: 150, lastAccess: '2024-12-14', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-04-15' },
            { id: 58, firstName: 'Edward', lastName: 'James', email: 'edward.james@yale.edu', reportsUsed: 45, reportsTotal: 100, lastAccess: '2024-12-13', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-04-20' },
            { id: 59, firstName: 'Susan', lastName: 'Watson', email: 'susan.watson@yale.edu', reportsUsed: 78, reportsTotal: 120, lastAccess: '2024-12-12', licenseStatus: 'Active', type: 'Other', createdDate: '2024-04-25' },
            { id: 60, firstName: 'Brian', lastName: 'Brooks', email: 'brian.brooks@yale.edu', reportsUsed: 23, reportsTotal: 80, lastAccess: '2024-12-11', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-04-30' },
            { id: 61, firstName: 'Jessica', lastName: 'Kelly', email: 'jessica.kelly@yale.edu', reportsUsed: 56, reportsTotal: 100, lastAccess: '2024-12-10', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-05-05' },
            { id: 62, firstName: 'Ronald', lastName: 'Sanders', email: 'ronald.sanders@yale.edu', reportsUsed: 89, reportsTotal: 150, lastAccess: '2024-12-09', licenseStatus: 'Active', type: 'Other', createdDate: '2024-05-10' },
            { id: 63, firstName: 'Sarah', lastName: 'Price', email: 'sarah.price@yale.edu', reportsUsed: 34, reportsTotal: 90, lastAccess: '2024-12-08', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-05-15' },
            { id: 64, firstName: 'Anthony', lastName: 'Bennett', email: 'anthony.bennett@yale.edu', reportsUsed: 67, reportsTotal: 110, lastAccess: '2024-12-07', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-05-20' },
            { id: 65, firstName: 'Karen', lastName: 'Wood', email: 'karen.wood@yale.edu', reportsUsed: 45, reportsTotal: 100, lastAccess: '2024-12-06', licenseStatus: 'Active', type: 'Other', createdDate: '2024-05-25' },
            { id: 66, firstName: 'Kevin', lastName: 'Barnes', email: 'kevin.barnes@yale.edu', reportsUsed: 78, reportsTotal: 130, lastAccess: '2024-12-05', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-05-30' },
            { id: 67, firstName: 'Nancy', lastName: 'Ross', email: 'nancy.ross@yale.edu', reportsUsed: 23, reportsTotal: 70, lastAccess: '2024-12-04', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-06-05' },
            { id: 68, firstName: 'Jason', lastName: 'Henderson', email: 'jason.henderson@yale.edu', reportsUsed: 56, reportsTotal: 90, lastAccess: '2024-12-03', licenseStatus: 'Active', type: 'Other', createdDate: '2024-06-10' },
            { id: 69, firstName: 'Betty', lastName: 'Coleman', email: 'betty.coleman@yale.edu', reportsUsed: 89, reportsTotal: 140, lastAccess: '2024-12-02', licenseStatus: 'Active', type: 'IVG', createdDate: '2024-06-15' },
            { id: 70, firstName: 'Gary', lastName: 'Jenkins', email: 'gary.jenkins@yale.edu', reportsUsed: 34, reportsTotal: 80, lastAccess: '2024-12-01', licenseStatus: 'Active', type: 'IPG', createdDate: '2024-06-20' }
          ],
          
          // Track license usage and history
          licenseHistory: [
            {
              userId: 1,
              licenses: [
                {
                  id: 1,
                  startDate: '2024-03-15',
                  endDate: '2025-03-15',
                  reportsTotal: 100,
                  reportsUsed: 45,
                  status: 'Active',
                  application: 'Research Suite Pro'
                }
              ]
            },
            {
              userId: 2,
              licenses: [
                {
                  id: 2,
                  startDate: '2024-06-20',
                  endDate: '2025-06-20',
                  reportsTotal: 150,
                  reportsUsed: 78,
                  status: 'Active',
                  application: 'Enterprise Analytics'
                }
              ]
            },
            {
              userId: 3,
              licenses: [
                {
                  id: 3,
                  startDate: '2023-12-01',
                  endDate: '2024-12-01',
                  reportsTotal: 120,
                  reportsUsed: 120,
                  status: 'Expired',
                  application: 'Academic Research'
                }
              ]
            },
            {
              userId: 4,
              licenses: [
                {
                  id: 4,
                  startDate: '2024-01-30',
                  endDate: '2025-01-30',
                  reportsTotal: 50,
                  reportsUsed: 12,
                  status: 'Active',
                  application: 'Basic Research'
                }
              ]
            },
            {
              userId: 5,
              licenses: [
                {
                  id: 5,
                  startDate: '2024-04-10',
                  endDate: '2025-04-10',
                  reportsTotal: 200,
                  reportsUsed: 89,
                  status: 'Active',
                  application: 'Premium Analytics'
                }
              ]
            }
          ],
          
          // Module usage tracking
          moduleUsage: {
            'Data Analysis': 324,
            'Report Generation': 177,
            'Visualization': 523,
            'Export Tools': 202
          }
        },

        // Computed properties that sync data across all views
        get users() {
          return this.dataStore.users;
        },

        get subscriptions() {
          return this.dataStore.subscriptions;
        },

        get moduleUsage() {
          return Object.entries(this.dataStore.moduleUsage).map(([name, usage]) => ({ name, usage }));
        },

        newUser: {
          firstName: '',
          lastName: '',
          institution: '',
          email: '',
          reportsTotal: 0,
          expiryDate: ''
        },

        newSubscription: {
          userId: '',
          startDate: '',
          endDate: '',
          reportsTotal: 0,
          application: '',
          totalValue: 0
        },

        newEmail: {
          email: '',
          subscriptionId: ''
        },

        // Synchronized computed properties
        get filteredUsers() {
          let filtered = this.users.filter(user => 
            user.firstName.toLowerCase().includes(this.userSearch.toLowerCase()) ||
            user.lastName.toLowerCase().includes(this.userSearch.toLowerCase()) ||
            user.institution.toLowerCase().includes(this.userSearch.toLowerCase()) ||
            user.email.toLowerCase().includes(this.userSearch.toLowerCase())
          );
          
          filtered.sort((a, b) => {
            let aVal = a[this.userSortBy];
            let bVal = b[this.userSortBy];
            if (this.userSortOrder === 'asc') {
              return aVal > bVal ? 1 : -1;
            } else {
              return aVal < bVal ? 1 : -1;
            }
          });
          
          return filtered;
        },

        get filteredSubscriptions() {
          let filtered = this.subscriptions.filter(sub => 
            sub.userFirstName.toLowerCase().includes(this.subscriptionSearch.toLowerCase()) ||
            sub.userLastName.toLowerCase().includes(this.subscriptionSearch.toLowerCase()) ||
            sub.institution.toLowerCase().includes(this.subscriptionSearch.toLowerCase()) ||
            sub.email.toLowerCase().includes(this.subscriptionSearch.toLowerCase())
          );
          
          filtered.sort((a, b) => {
            let aVal = a[this.subscriptionSortBy];
            let bVal = b[this.subscriptionSortBy];
            if (this.subscriptionSortOrder === 'asc') {
              return aVal > bVal ? 1 : -1;
            } else {
              return aVal < bVal ? 1 : -1;
            }
          });
          
          return filtered;
        },

        get expiring30Days() {
          return this.subscriptions.filter(sub => {
            const daysUntilExpiry = this.getDaysUntilExpiry(sub.expiryDate);
            return daysUntilExpiry <= 30 && daysUntilExpiry > 0;
          });
        },

        get expiring60Days() {
          return this.subscriptions.filter(sub => {
            const daysUntilExpiry = this.getDaysUntilExpiry(sub.expiryDate);
            return daysUntilExpiry <= 60 && daysUntilExpiry > 30;
          });
        },

        get expiring90Days() {
          return this.subscriptions.filter(sub => {
            const daysUntilExpiry = this.getDaysUntilExpiry(sub.expiryDate);
            return daysUntilExpiry <= 90 && daysUntilExpiry > 60;
          });
        },

        get expiringSubscriptions() {
          return [...this.expiring30Days, ...this.expiring60Days, ...this.expiring90Days];
        },

        get mostActiveUsers() {
          return [...this.users].sort((a, b) => b.reportsUsed - a.reportsUsed).slice(0, 5);
        },

        get totalReportsUsed() {
          return this.users.reduce((total, user) => total + user.reportsUsed, 0);
        },

        get monthlyRevenue() {
          return this.subscriptions.reduce((total, sub) => total + sub.totalValue, 0);
        },

        get totalModuleUsage() {
          return Object.values(this.dataStore.moduleUsage).reduce((total, usage) => total + usage, 0);
        },

        getDaysUntilExpiry(expiryDate) {
          const today = new Date();
          const expiry = new Date(expiryDate);
          const diffTime = expiry - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays;
        },

        // Synchronized data methods
        syncUserData(userId) {
          const user = this.users.find(u => u.id === userId);
          const subscription = this.subscriptions.find(s => s.userId === userId);
          
          if (user && subscription) {
            // Sync reports used
            subscription.reportsUsed = user.reportsUsed;
            subscription.reportsTotal = user.reportsTotal;
            
            // Sync status
            subscription.status = user.status;
            
            // Sync dates
            subscription.expiryDate = user.expiryDate;
            subscription.activationDate = user.activationDate;
          }
        },

        syncSubscriptionData(subscriptionId) {
          const subscription = this.subscriptions.find(s => s.id === subscriptionId);
          const user = this.users.find(u => u.id === subscription.userId);
          
          if (subscription && user) {
            // Sync user data from subscription
            user.reportsUsed = subscription.reportsUsed;
            user.reportsTotal = subscription.reportsTotal;
            user.status = subscription.status;
            user.expiryDate = subscription.expiryDate;
            user.activationDate = subscription.activationDate;
          }
        },

        generateExpiringList(days) {
          const expiringList = this.subscriptions.filter(sub => {
            const daysUntilExpiry = this.getDaysUntilExpiry(sub.expiryDate);
            return daysUntilExpiry <= days && daysUntilExpiry > 0;
          });
          
          console.log(`Subscriptions expiring in ${days} days:`, expiringList);
          alert(`Found ${expiringList.length} subscriptions expiring in ${days} days. Check console for details.`);
        },

        createUser() {
          const newId = Math.max(...this.users.map(u => u.id)) + 1;
          const user = {
            ...this.newUser,
            id: newId,
            status: 'Active',
            activationDate: new Date().toISOString().split('T')[0],
            createdDate: new Date().toISOString().split('T')[0],
            reportsUsed: 0,
            lastAccess: new Date().toISOString().split('T')[0],
            totalUsage: 0,
            moduleUsage: {
              'Data Analysis': 0,
              'Report Generation': 0,
              'Visualization': 0,
              'Export Tools': 0
            }
          };
          
          // Add to data store
          this.dataStore.users.push(user);
          
          // Create corresponding subscription
          const subscription = {
            id: newId,
            userId: newId,
            userFirstName: user.firstName,
            userLastName: user.lastName,
            institution: user.institution,
            email: user.email,
            status: 'Active',
            expiryDate: user.expiryDate,
            activationDate: user.activationDate,
            reportsUsed: 0,
            reportsTotal: user.reportsTotal,
            totalValue: user.reportsTotal * 25, // Calculate based on reports
            application: 'Basic Research',
            lastRun: new Date().toISOString().split('T')[0],
            shares: 0,
            timeSpent: 0
          };
          
          this.dataStore.subscriptions.push(subscription);
          
          // Add to license history
          this.dataStore.licenseHistory.push({
            userId: newId,
            licenses: [{
              id: newId,
              startDate: user.activationDate,
              endDate: user.expiryDate,
              reportsTotal: user.reportsTotal,
              reportsUsed: 0,
              status: 'Active',
              application: 'Basic Research'
            }]
          });
          
          this.showCreateUserModal = false;
          this.newUser = {
            firstName: '',
            lastName: '',
            institution: '',
            email: '',
            reportsTotal: 0,
            expiryDate: ''
          };
        },

        createSubscription() {
          const user = this.users.find(u => u.id == this.newSubscription.userId);
          const newId = Math.max(...this.subscriptions.map(s => s.id)) + 1;
          
          const subscription = {
            id: newId,
            userId: this.newSubscription.userId,
            userFirstName: user.firstName,
            userLastName: user.lastName,
            institution: user.institution,
            email: user.email,
            status: 'Active',
            expiryDate: this.newSubscription.endDate,
            activationDate: this.newSubscription.startDate,
            reportsUsed: 0,
            reportsTotal: this.newSubscription.reportsTotal,
            totalValue: this.newSubscription.totalValue,
            application: this.newSubscription.application,
            lastRun: new Date().toISOString().split('T')[0],
            shares: 0,
            timeSpent: 0
          };
          
          this.dataStore.subscriptions.push(subscription);
          
          // Update user data
          user.reportsTotal += this.newSubscription.reportsTotal;
          user.status = 'Active';
          user.expiryDate = this.newSubscription.endDate;
          
          // Update license history
          const userHistory = this.dataStore.licenseHistory.find(h => h.userId == this.newSubscription.userId);
          if (userHistory) {
            userHistory.licenses.push({
              id: newId,
              startDate: this.newSubscription.startDate,
              endDate: this.newSubscription.endDate,
              reportsTotal: this.newSubscription.reportsTotal,
              reportsUsed: 0,
              status: 'Active',
              application: this.newSubscription.application
            });
          }
          
          this.showCreateSubscriptionModal = false;
          this.newSubscription = {
            userId: '',
            startDate: '',
            endDate: '',
            reportsTotal: 0,
            application: '',
            totalValue: 0
          };
        },

        addEmailToSubscription() {
          console.log('Adding email to subscription:', this.newEmail);
          this.showAddEmailModal = false;
          this.newEmail = {
            email: '',
            subscriptionId: ''
          };
          alert('Email added to subscription. User will receive invitation to create account.');
        },

        editUser(user) {
          console.log('Editing user:', user);
          // Sync changes to subscription
          this.syncUserData(user.id);
        },

        viewUserHistory(user) {
          const history = this.dataStore.licenseHistory.find(h => h.userId === user.id);
          console.log('User history:', history);
          alert(`Viewing history for ${user.firstName} ${user.lastName}. Check console for details.`);
        },

        editSubscription(subscription) {
          console.log('Editing subscription:', subscription);
          // Sync changes to user
          this.syncSubscriptionData(subscription.id);
        },

        extendSubscription(subscription) {
          console.log('Extending subscription:', subscription);
          // Implementation for extending subscription
          const newExpiryDate = new Date(subscription.expiryDate);
          newExpiryDate.setFullYear(newExpiryDate.getFullYear() + 1);
          subscription.expiryDate = newExpiryDate.toISOString().split('T')[0];
          
          // Sync to user
          this.syncSubscriptionData(subscription.id);
        },

        transferReports(subscription) {
          console.log('Transferring reports from subscription:', subscription);
          // Implementation for transferring reports
          alert('Report transfer functionality would be implemented here.');
        },

        // Update module usage when user accesses modules
        updateModuleUsage(userId, moduleName, usageTime) {
          const user = this.users.find(u => u.id === userId);
          if (user && user.moduleUsage[moduleName] !== undefined) {
            user.moduleUsage[moduleName] += usageTime;
            user.totalUsage += usageTime;
            user.lastAccess = new Date().toISOString().split('T')[0];
            
            // Update global module usage
            this.dataStore.moduleUsage[moduleName] += usageTime;
          }
        },

        // Update report usage
        updateReportUsage(userId, reportsUsed) {
          const user = this.users.find(u => u.id === userId);
          const subscription = this.subscriptions.find(s => s.userId === userId);
          
          if (user && subscription) {
            user.reportsUsed = reportsUsed;
            subscription.reportsUsed = reportsUsed;
            user.lastAccess = new Date().toISOString().split('T')[0];
            subscription.lastRun = new Date().toISOString().split('T')[0];
          }
        },

        // Subscription details functions
        viewSubscriptionDetails(subscription) {
          this.selectedSubscription = subscription;
          this.showSubscriptionDetails = true;
        },

        getSubscriptionUser(userId) {
          return this.dataStore.subscriptionUsers.find(u => u.id === userId) || {
            firstName: 'Unknown',
            lastName: 'User',
            email: 'unknown@example.com',
            reportsUsed: 0,
            reportsTotal: 0,
            lastAccess: 'Never'
          };
        },

        getSubscriptionUserTypes(userId) {
          const user = this.getSubscriptionUser(userId);
          if (Array.isArray(user.types)) {
            return user.types;
          }
          if (typeof user.type === 'string' && user.type.trim()) {
            return user.type.split(',').map(t => t.trim()).filter(Boolean);
          }
          return [];
        },

        getAdminUser(adminUserId) {
          return this.getSubscriptionUser(adminUserId);
        },

        removeUserFromSubscription(subscriptionId, userId) {
          const subscription = this.subscriptions.find(s => s.id === subscriptionId);
          if (subscription && userId !== subscription.adminUserId) {
            subscription.users = subscription.users.filter(id => id !== userId);
            subscription.numberOfUsers = subscription.users.length;
            alert(`User removed from subscription ${subscription.subscriptionID}`);
          } else {
            alert('Cannot remove admin user from subscription');
          }
        },

        changeAdmin(subscriptionId, userId) {
          this.newAdminUserId = userId;
          this.showChangeAdminModal = true;
        },

        confirmChangeAdmin() {
          if (this.newAdminUserId && this.selectedSubscription) {
            this.selectedSubscription.adminUserId = this.newAdminUserId;
            this.showChangeAdminModal = false;
            this.newAdminUserId = '';
            alert('Admin changed successfully');
          }
        },

        backToSubscriptionList() {
          this.showSubscriptionDetails = true;
          this.selectedSubscription = null;
        },

        // Get user subscription count
        getUserSubscriptionCount(userId) {
          return this.subscriptions.filter(s => s.users.includes(userId)).length;
        }
      }
    }
  </script>
</body>
</html>